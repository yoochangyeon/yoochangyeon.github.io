---
import { Icon } from 'astro-icon/components';
---

<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
  aria-modal="true"
  role="dialog"
>
  <div class="relative w-full max-w-2xl mx-4 bg-white dark:bg-neutral-900 rounded-lg shadow-xl">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-neutral-700">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">게시글 찾기</h3>
      <button
        id="close-search-modal"
        type="button"
        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"
        aria-label="검색 닫기"
      >
        <Icon name="tabler:x" class="w-5 h-5" />
      </button>
    </div>

    <!-- Search Input -->
    <div class="p-4">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <Icon name="tabler:search" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
        </div>
        <input
          type="text"
          id="search-input"
          class="block w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-neutral-800 dark:border-neutral-600 dark:placeholder-neutral-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
          placeholder="제목이나 내용으로 검색하세요..."
          autocomplete="off"
        />
      </div>
    </div>

    <!-- Results -->
    <div id="search-results" class="p-4 max-h-96 overflow-y-auto">
      <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
        검색어를 입력해주세요
      </p>
    </div>
  </div>
</div>

<script>
  interface Post {
    title: string;
    excerpt: string;
    category: string;
    tags: string[];
    publishDate: string;
    url: string;
  }

  let posts: Post[] = [];
  let isLoading = false;

  async function loadPosts() {
    if (posts.length > 0 || isLoading) return;

    isLoading = true;
    try {
      const response = await fetch('/search-index.json');
      posts = await response.json();
    } catch (error) {
      console.error('Failed to load search index:', error);
      posts = [];
    } finally {
      isLoading = false;
    }
  }

  function searchPosts(query: string): Post[] {
    if (!query.trim()) return [];

    const lowerQuery = query.toLowerCase();

    return posts.filter(post => {
      const titleMatch = post.title.toLowerCase().includes(lowerQuery);
      const excerptMatch = post.excerpt.toLowerCase().includes(lowerQuery);
      const categoryMatch = post.category.toLowerCase().includes(lowerQuery);
      const tagsMatch = post.tags.some(tag => tag.toLowerCase().includes(lowerQuery));

      return titleMatch || excerptMatch || categoryMatch || tagsMatch;
    }).slice(0, 10); // Limit to 10 results
  }

  function formatDate(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  }

  function highlightText(text: string, query: string): string {
    if (!query.trim()) return text;

    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-800">$1</mark>');
  }

  function renderResults(results: Post[], query: string) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;

    if (results.length === 0) {
      resultsContainer.innerHTML = `
        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
          "${query}"에 대한 검색 결과가 없습니다
        </p>
      `;
      return;
    }

    resultsContainer.innerHTML = `
      <div class="space-y-4">
        ${results.map(post => `
          <a
            href="${post.url}"
            class="block p-4 rounded-lg border border-gray-200 dark:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors"
          >
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                  ${highlightText(post.title, query)}
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
                  ${highlightText(post.excerpt, query)}
                </p>
                <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-500">
                  <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                    ${post.category}
                  </span>
                  <span>${formatDate(post.publishDate)}</span>
                </div>
              </div>
            </div>
          </a>
        `).join('')}
      </div>
    `;
  }

  document.addEventListener('astro:page-load', () => {
    const modal = document.getElementById('search-modal');
    const closeButton = document.getElementById('close-search-modal');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;

    if (!modal || !closeButton || !searchInput) return;

    // Open modal
    window.addEventListener('open-search-modal', async () => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      searchInput.focus();

      // Load posts when modal opens
      await loadPosts();
    });

    // Close modal
    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      searchInput.value = '';
      const resultsContainer = document.getElementById('search-results');
      if (resultsContainer) {
        resultsContainer.innerHTML = `
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
            검색어를 입력해주세요
          </p>
        `;
      }
    }

    closeButton.addEventListener('click', closeModal);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Search on input
    let searchTimeout: number;
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;

      clearTimeout(searchTimeout);
      searchTimeout = window.setTimeout(() => {
        const results = searchPosts(query);
        renderResults(results, query);
      }, 300);
    });
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
