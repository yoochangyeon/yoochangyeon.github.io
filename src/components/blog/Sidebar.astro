---
import { getCollection } from 'astro:content';
import { getPermalink, getAsset, cleanSlug } from '~/utils/permalinks';
import authorData from '~/data/author.json';
import { Image } from 'astro:assets';
import { Icon } from 'astro-icon/components';
import profileImage from '~/assets/images/avatar.png';

const { name, nameEn, tagline } = authorData;

// Get all posts and count by category
const posts = await getCollection('post');
const publishedPosts = posts.filter((post) => !post.data.draft);

const categoryMap = new Map<string, number>();
publishedPosts.forEach((post) => {
  const category = post.data.category;
  if (category) {
    categoryMap.set(category, (categoryMap.get(category) || 0) + 1);
  }
});

const categories = Array.from(categoryMap.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);

const totalPosts = publishedPosts.length;
---

<aside class="space-y-8">
  <!-- Profile Section -->
  <div class="bg-white dark:bg-neutral-900 rounded-lg p-6 border border-gray-200 dark:border-neutral-700">
    <div class="flex items-center gap-4 mb-4">
      <Image
        src={profileImage}
        alt={name}
        width={64}
        height={64}
        class="w-16 h-16 rounded-full bg-white border-2 border-gray-200 dark:border-neutral-700 shadow-md flex-shrink-0"
      />
      <div>
        <h3 class="text-lg font-bold text-gray-900 dark:text-white">
          {name}
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          {nameEn}
        </p>
      </div>
    </div>
    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
      {tagline}
    </p>
    <div class="flex items-center gap-3">
      <a
        href="https://github.com/yoochangyeon"
        target="_blank"
        rel="noopener noreferrer"
        class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
        aria-label="GitHub"
      >
        <Icon name="tabler:brand-github" class="w-5 h-5" />
      </a>
      <a
        href={getAsset('/rss.xml')}
        class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
        aria-label="RSS"
      >
        <Icon name="tabler:rss" class="w-5 h-5" />
      </a>
    </div>
  </div>

  <!-- Category Tree -->
  <div class="bg-white dark:bg-neutral-900 rounded-lg p-6 border border-gray-200 dark:border-neutral-700">
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
      카테고리
    </h3>

    <nav class="space-y-2">
      <!-- All Posts -->
      <a
        href={getPermalink('/')}
        class="flex items-center justify-between px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors group"
      >
        <span class="text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 font-medium">
          전체 글
        </span>
        <span class="text-sm text-gray-500 dark:text-gray-400">
          {totalPosts}
        </span>
      </a>

      <!-- Categories -->
      {categories.map(({ name, count }) => (
        <a
          href={getPermalink(cleanSlug(name), 'category')}
          class="flex items-center justify-between px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors group"
        >
          <span class="text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400">
            {name}
          </span>
          <span class="text-sm text-gray-500 dark:text-gray-400">
            {count}
          </span>
        </a>
      ))}
    </nav>
  </div>
</aside>
