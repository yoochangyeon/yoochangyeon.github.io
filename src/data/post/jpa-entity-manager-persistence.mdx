---
publishDate: 2022-04-03T00:00:00Z
author: "유창연"
title: "JPA에서 영속성 관리 (Entity Manager, Entity Manager Factory)"
image: "~/assets/images/posts/jpa-entity-manager-persistence/image-0.png"
excerpt: "JPA 영속성 컨텍스트의 개념과 엔티티 매니저의 역할을 정리합니다. 1차 캐시, 쓰기 지연, 변경 감지 등 핵심 동작 원리를 다룹니다."
category: "Backend"
tags: ["jpa","entity-manager","persistence"]
draft: false
---

### 엔티티 매니저

- 엔티티를 저장, 수정, 삭제, 조회등 엔티티 관련된 모든 일을 처리한다.
- 엔티티를 관리하는 관리자
- 생성 비용이 거의 없다.
- DB커넥션이 꼭 필요한 시점까지 커넥션을 얻지 욊는다.

![](~/assets/images/posts/jpa-entity-manager-persistence/image-1.png)

 

### 엔티티 매니저 팩토리

- 엔티티를 만드는 공장
- 생성 비용이 크다. 따라서 보통 하나만 만들어서 사용한다.

 

### 엔티티 매니저와 엔티티 매니저 팩토리의 스레드 동시 접근

엔티티 매니저를 팩토리는 여러 스레드가 동시에 접근해도 안전한다.

엔티티 매니저는 여러 스래드가 동시에 접근하면 **동시성 문제가 발생**한다. **스레드간에 절대 공유되면 안된다.**

 

### 영속성 컨텍스트

- 엔티티를 영구 저장하는 환경
- 엔티티를 어떻게 식별하는가? : @Id로 테이블 키와 매핑된 값. 즉, 식별자로 구분한다. 영속성 컨텍스트는 식별자 값이 반드시 있어야한다.
- 트랜젝션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티가 데이터베이스에 반영된다.
- 1차 캐시를 가지고 있다.
- 여러 장점이 있다. (1차 캐시, 동일성 보장, 트랙잭션을 지원하는 쓰기 지연, 변경 감지, 지연 로딩)

 

### 1차 캐시

- 캐시의 키는 식별자 값이다. db의 기본키와 매핑되어있다.
- 엔티티 매니저에서 find가 호출되면 1차 캐시에서 먼저 엔티티를 찾고, 없다면 데이터베이스에서 조회한다.
- 데이터베이스에서 조회가 되면 1차 캐시에 저장하고 영속된 엔티티를 반환해서 가져온다.

 

### 쓰기 지연

- 엔티티 매니저는 트랜잭션을 커밋하는 시점까지 데이터베이스에 엔티티를 저장하지 않고 모아둔다.
- 쓰기 지연 SQL저장소에 쿼리를 모앀두었다가 필요한 시점에 쿼리를 보낸다.
- 커밋이 될 때 flush를 진행해 db에 동기화를 해주고 db의 트랜잭션을 커밋한다.

 

![](~/assets/images/posts/jpa-entity-manager-persistence/image-2.png)

### 엔티티의 생명주기

- 비영속 : 영속성 컨텍스트와 전혀 관계가 없는 상태
- 영속 : 영속성 컨텍스트에 저장된 상태, 엔티티가 영속성 컨텍스트에 의해 관리된다는 의미.
- 준영속 : 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제 : 삭제된 상태

 

### 변경감지

엔티티의 변경사항을 데이터베이스에 자동으로 반영하는 기능

1. 엔티티를 영속성 컨텍스트에 보관할 때, 최초 상태를 복사해서 저장해둔다. -> 스냅샷
2. 트랜잭션이 커밃될 때, flush가 호출된다.
3. 엔티티와 스냅샷을 비교해 변경된 엔티티를 찾는다.
4. 변경된 엔티티가 있으면 수정 쿼리를 생성해서 쓰기 지연 SQL저장소에 보낸다.
5. 쓰기 지연 저장소의 SQL을 데이터베이스에 보낸다.
6. 데이터베이스 트랜잭션을 커밋한다.

 

JPA는 모든 필드를 업데이트한다. 때문에 수정 쿼리가 항상 같다.

**필드가 너무 많거나 내용이 너무 크면** **@DynamicUpdate**를 사용해서 수정된 데이터만 사용해서 동적으로 쿼리를 생성하는 전략을 선택해주면 된다.
